<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for textarea */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        textarea::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        /* Style for select dropdown arrows */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-full overflow-hidden">
    <div class="flex flex-col lg:flex-row h-full">
        
        <!-- Left Panel: Input -->
        <div class="lg:w-1/3 h-1/2 lg:h-full flex flex-col p-6 border-b lg:border-r border-gray-700 space-y-4 overflow-y-auto">
            <h1 class="text-3xl font-bold text-indigo-400">Data Visualizer</h1>
            <p class="text-gray-400">
                Upload a CSV file or paste your data below. The first row must be headers (e.g., "Product", "Sales", "Month").
            </p>

            <!-- NEW: File Upload -->
            <div>
                <label for="csv-upload" class="block text-sm font-medium text-gray-300 mb-1">Upload CSV File (.csv)</label>
                <input type="file" id="csv-upload" accept=".csv" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 transition-colors duration-200 ease-in-out cursor-pointer"/>
            </div>
            
            <!-- CSV Input Textarea -->
            <textarea id="csvData"
                class="w-full h-64 lg:flex-1 p-4 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Example:
Product,Sales,Month
Item A,10,Jan
Item B,20,Feb
Item C,15,Jan
Item D,30,Mar
"></textarea>

            <!-- NEW: Clear Button -->
            <button id="btn-clear" class="w-full px-4 py-2 bg-gray-600 rounded-lg font-semibold hover:bg-gray-500 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 text-sm">
                Clear Data
            </button>
            
            <!-- Chart Controls -->
            <div class="space-y-4">
                <!-- X-Axis Select -->
                <div>
                    <label for="x-axis-select" class="block text-sm font-medium text-gray-300 mb-1">Select X-Axis (Labels)</label>
                    <select id="x-axis-select" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <!-- Options will be populated by JavaScript -->
                        <option value="" disabled selected>---</option>
                    </select>
                </div>

                <!-- Y-Axis Select -->
                <div>
                    <label for="y-axis-select" class="block text-sm font-medium text-gray-300 mb-1">Select Y-Axis (Values)</label>
                    <select id="y-axis-select" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <!-- Options will be populated by JavaScript -->
                        <option value="" disabled>---</option>
                    </select>
                </div>

                <!-- Multi-select Toggle -->
                <div class="flex items-center">
                    <input id="multi-select-toggle" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-800 text-indigo-600 focus:ring-indigo-500">
                    <label for="multi-select-toggle" class="ml-2 block text-sm text-gray-300">Compare Multiple Y-Axes</label>
                </div>

                <!-- Generate Chart Buttons -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <button id="btn-bar" class="w-full px-4 py-3 bg-indigo-600 rounded-lg font-semibold hover:bg-indigo-500 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75">
                        Bar Chart
                    </button>
                    <button id="btn-line" class="w-full px-4 py-3 bg-indigo-600 rounded-lg font-semibold hover:bg-indigo-500 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75">
                        Line Graph
                    </button>
                    <button id="btn-pie" class="w-full px-4 py-3 bg-indigo-600 rounded-lg font-semibold hover:bg-indigo-500 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75">
                        Pie Chart
                    </button>
                </div>

                <!-- NEW: Download Chart Button -->
                <button id="btn-download" class="w-full px-4 py-3 bg-green-600 rounded-lg font-semibold hover:bg-green-500 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                    Download Chart
                </button>
            </div>

            <!-- Error Message Box (MOVED TO RIGHT PANEL) -->
        </div>
        
        <!-- Right Panel: Chart Output -->
        <div class="lg:w-2/3 h-1/2 lg:h-full flex flex-col items-center justify-center p-6">
            
            <!-- Error Message Box (Moved here) -->
            <div id="errorBox" class="hidden p-3 bg-red-800 border border-red-600 text-red-100 rounded-lg w-full max-w-4xl mx-auto mb-4">
                <span class="font-semibold">Error:</span> <span id="errorMessage"></span>
            </div>

            <div id="chart-container" class="relative w-full h-full max-w-4xl mx-auto">
                <!-- Canvas for Chart.js -->
                <canvas id="myChart"></canvas>
                
                <!-- Initial placeholder message -->
                <div id="placeholderMessage" class="absolute inset-0 flex items-center justify-center text-gray-500 text-xl">
                    Paste your data and select options to generate a chart.
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // --- Element References ---
        const ctx = document.getElementById('myChart').getContext('2d');
        const csvDataEl = document.getElementById('csvData');
        const xAxisSelect = document.getElementById('x-axis-select');
        const yAxisSelect = document.getElementById('y-axis-select');
        const multiSelectToggle = document.getElementById('multi-select-toggle');
        const btnBar = document.getElementById('btn-bar');
        const btnLine = document.getElementById('btn-line');
        const btnPie = document.getElementById('btn-pie');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const placeholderMessage = document.getElementById('placeholderMessage');
        const chartContainer = document.getElementById('chart-container');
        // --- NEW Element References ---
        const btnDownload = document.getElementById('btn-download');
        const btnClear = document.getElementById('btn-clear');
        const csvUpload = document.getElementById('csv-upload');
        
        let myChart = null;

        // --- Event Listeners ---
        // 1. Update dropdowns whenever user types in the textarea
        csvDataEl.addEventListener('input', updateColumnSelectors);
        
        // 2. Add listener for the new toggle checkbox
        multiSelectToggle.addEventListener('change', handleToggleMode);

        // 3. Add listeners for the new chart buttons
        btnBar.addEventListener('click', () => generateChart('bar'));
        btnLine.addEventListener('click', () => generateChart('line'));
        btnPie.addEventListener('click', () => generateChart('pie'));

        // --- NEW Event Listeners ---
        // 4. Add listener for the file upload
        csvUpload.addEventListener('change', handleFileUpload);

        // 5. Add listener for the clear button
        btnClear.addEventListener('click', clearAll);

        // 6. Add listener for the download button
        btnDownload.addEventListener('click', downloadChart);


        /**
         * Hides or shows the error message box.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }
        function hideError() {
            errorBox.classList.add('hidden');
        }

        // --- NEW Functions ---

        /**
         * Handles the 'change' event of the file input.
         * Reads the file and puts its content into the textarea.
         */
        function handleFileUpload(event) {
            hideError();
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    csvDataEl.value = text;
                    // Manually trigger the header parse and dropdown update
                    updateColumnSelectors();
                } catch (err) {
                    showError("Could not read the uploaded file.");
                }
            };
            
            reader.onerror = function() {
                showError("Error reading file.");
            };
            
            reader.readAsText(file);
            
            // Clear the file input value so 'change' fires again if the same file is selected
            event.target.value = null;
        }

        /**
         * Clears the textarea, dropdowns, chart, and errors.
         */
        function clearAll() {
            csvDataEl.value = '';
            
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }
            
            // This function already handles clearing dropdowns when the text area is empty
            updateColumnSelectors(); 
            
            hideError();
            
            // Show the placeholder message again
            placeholderMessage.classList.remove('hidden');
        }

        /**
         * Triggers a download of the current chart as a PNG.
         */
        function downloadChart() {
            if (!myChart) {
                showError("No chart to download. Please generate a chart first.");
                return;
            }
            hideError();
            
            // Create a temporary link
            const link = document.createElement('a');
            link.href = myChart.toBase64Image('image/png');
            link.download = 'my_chart.png';
            
            // Programmatically click the link to trigger the download
            link.click();
        }

        // --- Existing Functions ---

        /**
         * Reads the first line of the CSV data and populates the
         * X and Y axis <select> dropdowns.
         */
        function updateColumnSelectors() {
            hideError();
            const csvString = csvDataEl.value;
            if (!csvString) {
                // Clear dropdowns if text area is empty
                xAxisSelect.innerHTML = '<option value="" disabled selected>---</option>';
                yAxisSelect.innerHTML = '<option value="" disabled selected>---</option>';
                return;
            }

            try {
                // Get the first line
                const firstLine = csvString.split('\n')[0].trim();
                // Split by comma
                const headers = firstLine.split(',');

                // Clear old options
                xAxisSelect.innerHTML = '';
                yAxisSelect.innerHTML = '';
                
                // Add default placeholder
                const placeholderOption = new Option('--- Select a column ---', '', true, true);
                placeholderOption.disabled = true;
                xAxisSelect.add(placeholderOption);
                yAxisSelect.add(placeholderOption.cloneNode(true));

                // Populate with new headers
                headers.forEach((header, index) => {
                    if (header.trim() === "") return; // Skip empty headers
                    // Use the column *index* as the value
                    const option = new Option(header.trim(), index);
                    xAxisSelect.add(option);
                    yAxisSelect.add(option.cloneNode(true));
                });

            } catch (e) {
                // Fail silently, likely just incomplete typing
                console.warn("Error parsing headers: ", e.message);
                xAxisSelect.innerHTML = '<option value="" disabled selected>---</option>';
                yAxisSelect.innerHTML = '<option value="" disabled selected>---</option>';
            }
        }

        /**
         * Handles the 'change' event of the 'Compare Multiple Y-Axes' checkbox.
         * Toggles the Y-Axis select mode and visibility of the Pie Chart button.
         */
        function handleToggleMode(event) {
            const isChecked = event.target.checked;
            
            if (isChecked) {
                // Enable multi-select
                yAxisSelect.multiple = true;
                yAxisSelect.size = 5;
                // Hide Pie chart button
                btnPie.style.display = 'none';
            } else {
                // Disable multi-select
                yAxisSelect.multiple = false;
                yAxisSelect.removeAttribute('size');
                // Show Pie chart button
                btnPie.style.display = 'block'; // Or 'inline-block' if it was
            }
        }

        /**
         * Orchestrator function called by the chart buttons.
         * Gathers all data and calls the parsing and drawing functions.
         * @param {string} chartType - 'bar', 'line', or 'pie'.
         */
        function generateChart(chartType) {
            hideError(); // Clear old errors (meets error handling req)
            
            try { // Main try...catch block (meets error handling req)
                // --- 1. Get X-Axis Selection ---
                const xColumnIndex = parseInt(xAxisSelect.value, 10);
                if (isNaN(xColumnIndex)) {
                    throw new Error("Please select an X-Axis column.");
                }
                const xLabel = xAxisSelect.options[xAxisSelect.selectedIndex].text;

                // --- 2. Get Y-Axis Selection (Single or Multi) ---
                let yColumnIndices = [];
                let yLabels = [];
                
                if (multiSelectToggle.checked) {
                    // Multi-select mode
                    const yAxisOptions = Array.from(yAxisSelect.selectedOptions);
                    if (yAxisOptions.length === 0) {
                        throw new Error("Please select at least one Y-Axis column.");
                    }
                    yColumnIndices = yAxisOptions.map(opt => parseInt(opt.value, 10));
                    yLabels = yAxisOptions.map(opt => opt.text);
                } else {
                    // Single-select mode
                    const yColumnIndex = parseInt(yAxisSelect.value, 10);
                    if (isNaN(yColumnIndex)) {
                        throw new Error("Please select a Y-Axis column.");
                    }
                    yColumnIndices.push(yColumnIndex);
                    yLabels.push(yAxisSelect.options[yAxisSelect.selectedIndex].text);
                }

                // --- 3. Validation ---
                if (yColumnIndices.some(isNaN)) {
                    throw new Error("One of the selected Y-Axis columns is invalid.");
                }
                if (yColumnIndices.includes(xColumnIndex)) {
                    throw new Error("X-Axis cannot be one of the selected Y-Axes.");
                }

                // --- 4. Get and Parse Data ---
                const csvString = csvDataEl.value;
                const { labels, valuesArrays } = parseSelectedColumns(csvString, xColumnIndex, yColumnIndices, yLabels);

                // --- 5. Build Datasets ---
                const datasets = valuesArrays.map((values, index) => {
                    const color = generateSingleColor();
                    
                    if (chartType === 'pie') {
                        // Pie charts need a color array for *data*, not dataset
                        return {
                            label: yLabels[index],
                            data: values,
                            backgroundColor: generateColors(labels.length), // Array of colors
                            borderWidth: 1
                        };
                    }
                    
                    // Bar and Line charts
                    return {
                        label: yLabels[index],
                        data: values,
                        borderColor: color,
                        backgroundColor: (chartType === 'bar') ? color : color.replace('1)', '0.2)'), // Solid for bar, transparent for line
                        borderWidth: (chartType === 'bar') ? 1 : 2,
                        fill: (chartType === 'line'),
                        tension: 0.1 // Slight curve for line
                    };
                });

                // --- 6. Draw the Chart ---
                drawChart(chartType, labels, datasets, xLabel, yLabels);

            } catch (error) {
                showError(error.message); // Show specific error (meets error handling req)
            }
        }

        /**
         * Parses the *entire* CSV string to extract data from specific columns.
         * @param {string} csvString - The full CSV text.
         * @param {number} xColumnIndex - The index of the column to use for labels (X-axis).
         * @param {number[]} yColumnIndices - Array of indices for the Y-axis columns.
         * @param {string[]} yLabels - Array of names for the Y-axis columns (for error reporting).
         * @returns {{labels: string[], valuesArrays: number[][]}}
         */
        function parseSelectedColumns(csvString, xColumnIndex, yColumnIndices, yLabels) {
            const lines = csvString.trim().split('\n');
            const labels = [];
            // Initialize an array of arrays, one for each y-axis
            const valuesArrays = yColumnIndices.map(() => []);

            if (lines.length < 2) {
                throw new Error("No data rows found in the CSV. (Requires at least 1 header and 1 data row)");
            }
            
            const allColumnIndices = [xColumnIndex, ...yColumnIndices];
            const maxIndex = Math.max(...allColumnIndices);

            // Loop from i = 1 to skip the header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Skip empty lines

                const parts = line.split(',');

                // Check if row has enough columns
                if (parts.length <= maxIndex) {
                    throw new Error(`Row ${i + 1} is malformed or missing data.`);
                }
                
                // Get X-Axis value (label)
                const label = parts[xColumnIndex].trim();
                labels.push(label);

                // Get Y-Axis values
                yColumnIndices.forEach((colIndex, j) => {
                    const valueString = parts[colIndex].trim();
                    const value = parseFloat(valueString);
                    
                    // Validate Y-Axis value
                    if (isNaN(value)) {
                        throw new Error(`Row ${i + 1} has a non-numeric value ('${valueString}') in the '${yLabels[j]}' column.`);
                    }
                    valuesArrays[j].push(value);
                });
            }
            
            if (labels.length === 0) {
                 throw new Error("Could not parse any data. Check your CSV format and column selections.");
            }

            return { labels, valuesArrays };
        }

        /**
         * Generates an array of random colors for charts.
         * Used for Pie charts.
         */
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * 255);
                const g = Math.floor(Math.random() * 200); // Keep it a bit darker
                const b = Math.floor(Math.random() * 255);
                colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
            }
            return colors;
        }

        /**
         * Generates a single random RGBA color string.
         */
        function generateSingleColor() {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 200); // Keep it a bit darker
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r}, ${g}, ${b}, 1)`; // Opaque for border
        }

        /**
         * Destroys any old chart and draws a new one on the canvas.
         * @param {string} type - The chart type ('bar', 'line', 'pie').
         * @param {string[]} labels - Array of labels for the X-axis.
         * @param {object[]} datasets - Array of dataset objects for Chart.js.
         * @param {string} xLabel - The name of the X-axis column.
         * @param {string[]} yLabels - Array of names for the Y-axis columns.
         */
        function drawChart(type, labels, datasets, xLabel, yLabels) {
            placeholderMessage.classList.add('hidden'); // Hide placeholder
            
            // Destroy the old chart if it exists
            if (myChart) {
                myChart.destroy();
            }
            
            // Create the new chart
            myChart = new Chart(ctx, {
                type: type, // Will be 'line'
                data: {
                    labels: labels,
                    datasets: datasets // Pass the pre-built datasets array
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: {
                                color: '#E5E7EB' // gray-200
                            }
                        },
                        title: {
                            display: true,
                            text: `${yLabels.join(' & ')} vs ${xLabel}`, // e.g., "Sales & Profit vs Month"
                            color: '#F9FAFB', // gray-50
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: (type === 'bar' || type === 'line') ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#4B5563' // gray-600
                            },
                            ticks: {
                                color: '#D1D5DB' // gray-300
                            },
                            title: {
                                display: true,
                                text: 'Values', // Generic title
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                color: '#4B5563' // gray-600
                            },
                            ticks: {
                                color: '#D1D5DB' // gray-300
                            },
                             title: {
                                display: true,
                                text: xLabel,
                                color: '#E5E7EB'
                            }
                        }
                    } : {} // No scales for pie chart
                }
            });
        }
    </script>
</body>
</html>